# 默认配置（更深/更宽模型以更好实现隐写与鲁棒解码）
# 可通过 configs/train.yaml 等 override 覆盖

project:
  output_dir: ./outputs/default
  save_every: 5000
  log_every: 100
  vis_every: 1000

data:
  # Stage2 显存大：DiS 18 层 Mamba + 256×256，48GB 单卡建议 2～4，24GB 建议 1～2
  batch_size: 1
  num_workers: 4
  split_ratios: [0.8, 0.1, 0.1]
  split_seed: 42
  num_train_samples: 10000
  # 训练 Stage2 用 cover 辅助（外观目标），测试无载体（仅 secret）。四个数据集按 split_ratios 逐数据集划分后合并。
  cover_roots:
    - ./data/placeholder/CelebA-HQ
    - ./data/placeholder/COCO
    - ./data/placeholder/DIV2K
    - ./data/placeholder/Paris_StreetView
  secret_roots:
    - ./data/placeholder/CelebA-HQ
    - ./data/placeholder/COCO
    - ./data/placeholder/DIV2K
    - ./data/placeholder/Paris_StreetView
  # 存在则从文件加载划分，不存在则按 ratios/seed 逐数据集划分并写入该文件，保证前后一致
  split_file: data/splits.json

train:
  epochs: 50
  lr_generator: 1e-4
  lr_decoder: 2e-4
  lr_rq_vae: 1e-4
  weight_decay: 0.01
  warmup_steps: 2000
  grad_clip: 1.0

# 生成器：DiS 主干 + Rectified Flow（加深加宽）
generator:
  img_size: 256
  patch_size: 4
  in_channels: 3
  out_channels: 3
  model_channels: 384  # 48GB 单卡 batch=1 可跑；512 易 OOM
  num_layers: 18
  d_state: 16
  d_conv: 4
  expand: 2
  # 须与文本编码器输出一致：OpenCLIP ViT-B-32 为 512 维，ViT-L/14 等为 768 维
  text_embed_dim: 512
  secret_embed_dim: 256
  num_flow_steps: 1000
  # 使用官方 mamba_ssm 的 Mamba（已安装 mamba-ssm）；设为 false 则退回纯 PyTorch Selective SSM
  use_mamba_ssm: true

# RQ-VAE：编码/解码每 block 残差层数 + 通道倍数
rq_vae:
  in_channels: 3
  latent_channels: 256
  num_embeddings: 8192
  num_layers: 4
  downsample: 8
  commitment_cost: 0.25
  channel_mult: [1, 2, 2, 4]
  num_res: 3

# 鲁棒解码器（hidden_dim 384 约 48GB 可跑；512 需梯度检查点或更大显存）
decoder:
  in_channels: 3
  hidden_dim: 384
  num_layers: 8
  d_state: 16
  d_conv: 4
  expand: 2
  num_rq_depths: 4
  num_embeddings: 8192
  # 使用官方 mamba_ssm 加速；设为 false 则退回纯 PyTorch Selective SSM
  use_mamba_ssm: true

loss:
  # 正交损失（结构/纹理互不干扰），替代已废弃的 rSMI 对齐
  lambda_orthogonal: 0.1
  orthogonal_last_only: false
  robust_depth_weights: [1.0, 0.8, 0.6, 0.4]
  robust_use_frequency: true
  lambda_flow: 1.0
  lambda_align: 0.1
  lambda_robust: 0.5
  use_hdce: true
  lambda_hdce: 0.5
  hdce_temperature: 0.07
  hdce_num_hard: 16
  # 为 false 时 L_robust 梯度回传生成器
  detach_for_robust: false

interference:
  operators: ["jpeg", "gaussian_noise", "crop", "blur"]
  noise_sigma_range: [0.0, 0.2]
  blur_sigma_range: [0.0, 2.0]
  crop_ratio_range: [0.5, 1.0]
  jpeg_quality_range: [30, 90]

eval:
  num_samples: 1000
  fid_batch_size: 50
  steganalysis_model: srnet
